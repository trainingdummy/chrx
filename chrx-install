#!/bin/bash
#
# chrx-install
#
# Chromebook Unix Installer
#

CHRX_VERSION="4.0.4"

# Default configuration
CHRX_DEFAULT_ROOTFS_URL="https://tinyurl.com/chrx-zorin-17"
CHRX_ROOTFS_URL=""
CHRX_ROOTFS_SIZE_GB=""
CHRX_TARGET_DISK=""
CHRX_HOSTNAME="chrx"
CHRX_USERNAME="chrx"
CHRX_LOCALE="en_US.UTF-8"
CHRX_TZ="America/New_York"
CHRX_ROOT_PASSWORD="chrx"

CHRX_CACHE_DIR="/var/cache/chrx"
CHRX_INSTALL_ROOT="/mnt/stateful_partition/chrxroot"

VERBOSITY=""
VERBOSITY_CURL="-#"
VERBOSITY_INSTALL=""

CHRX_PROMPT_ENABLED=1
CHRX_NOTIFY_ENABLED=1
CHRX_MODE=""

# Color codes
ANSI_RED=$'\033[1;31m'
ANSI_YEL=$'\033[1;33m'
ANSI_GRN=$'\033[1;32m'
ANSI_VIO=$'\033[1;35m'
ANSI_BLU=$'\033[1;36m'
ANSI_WHT=$'\033[1;37m'
ANSI_RST=$'\033[0m'

echo_cmd()    { echo -e "${ANSI_BLU}${@}${ANSI_RST}"; }
echo_note()   { echo -e "${ANSI_YEL}${@}${ANSI_RST}"; }
echo_info()   { echo -e "${ANSI_GRN}${@}${ANSI_RST}"; }
echo_prompt() { echo -e "${ANSI_WHT}${@}${ANSI_RST}"; }
echo_warn()   { echo -e "${ANSI_YEL}${@}${ANSI_RST}"; }
echo_debug()  { echo -e "${ANSI_VIO}${@}${ANSI_RST}"; }
echo_fail()   { echo -e "${ANSI_RED}${@}${ANSI_RST}"; }

eval_try()
{
  local _cmd=$@
  [ "$VERBOSE" ] && echo_cmd "$_cmd"
  eval $_cmd
}

eval_crit()
{
  local _cmd=$@
  [ "$VERBOSE" ] && echo_cmd "$_cmd"
  eval $_cmd
  rc=$?

  if [ "$rc" -ne 0 ]; then
    echo_fail "fatal: return code ${rc} from command \"${_cmd}\""
    exit $rc
  fi
}

prompt_if_interactive()
{
  PROMPT_RESPONSE=
  if [ "${CHRX_PROMPT_ENABLED}" ]; then
    read -e PROMPT_RESPONSE
  else
    echo
  fi
}

downcase() { echo "$@" | tr '[:upper:]' '[:lower:]'; }

detect_mode()
{
  local rootdev=$(rootdev -d -s 2>/dev/null)
  
  if [ -z "$rootdev" ]; then
    if [ -b /dev/mmcblk0 ]; then
      rootdev="/dev/mmcblk0"
    elif [ -b /dev/nvme0n1 ]; then
      rootdev="/dev/nvme0n1"
    elif [ -b /dev/sda ]; then
      rootdev="/dev/sda"
    else
      echo_fail "Unable to detect storage device"
      exit 1
    fi
  fi
  
  if [[ "${rootdev}" =~ "mmcblk" ]] || [[ "${rootdev}" =~ "nvme" ]]; then
    local part7="${rootdev}p7"
  else
    local part7="${rootdev}7"
  fi
  
  if [ -b "$part7" ]; then
    local fs_label=$(blkid -s LABEL -o value "$part7" 2>/dev/null)
    if [ "$fs_label" = "CHRX-ROOT" ]; then
      CHRX_MODE="install"
    else
      CHRX_MODE="partition"
      echo_warn "Partition 7 exists but appears incomplete. Will recreate it."
    fi
  else
    CHRX_MODE="partition"
  fi
}

show_welcome_banner()
{
  cat <<- EOBANNER
${ANSI_GRN}
╔═══════════════════════════════════════════════════════════════╗
║                                                               ║
║         chrx - Generic Chromebook Linux Installer             ║
║                      Version ${CHRX_VERSION}                            ║
║                                                               ║
╚═══════════════════════════════════════════════════════════════╝
${ANSI_RST}

EOBANNER
}

show_partition_mode_menu()
{
  cat <<- EOMENU

${ANSI_YEL}═══════════════════════════════════════════════════════════════${ANSI_RST}
${ANSI_YEL}                    PARTITION MODE                            ${ANSI_RST}
${ANSI_YEL}═══════════════════════════════════════════════════════════════${ANSI_RST}

This is your first time running chrx. We need to create a partition
for Linux before we can install anything.

${ANSI_RED}WARNING: This will modify your disk partitions!${ANSI_RST}
${ANSI_YEL}Make sure you have backups of any important data.${ANSI_RST}

EOMENU

  echo_prompt "How much space do you want for Linux? (in GB)"
  echo_note "Recommended: 16-32 GB for most distros, 64+ GB for desktop use"
  echo_prompt "Enter size in GB [default: 16]: \c"
  
  prompt_if_interactive
  CHRX_ROOTFS_SIZE_GB=${PROMPT_RESPONSE:-16}
  
  if ! [[ "$CHRX_ROOTFS_SIZE_GB" =~ ^[0-9]+$ ]]; then
    echo_fail "Invalid size. Please enter a number."
    exit 1
  fi
  
  if [ "$CHRX_ROOTFS_SIZE_GB" -lt 8 ]; then
    echo_fail "Size too small. Minimum 8 GB required."
    exit 1
  fi
}

show_install_mode_menu()
{
  cat <<- EOMENU

${ANSI_GRN}═══════════════════════════════════════════════════════════════${ANSI_RST}
${ANSI_GRN}                    INSTALLATION MODE                         ${ANSI_RST}
${ANSI_GRN}═══════════════════════════════════════════════════════════════${ANSI_RST}

Partition detected! Ready to install Linux.

EOMENU

  echo_prompt "Enter the URL to your Linux rootfs tar.gz file:"
  echo_note "Press [ENTER] for default: ${CHRX_DEFAULT_ROOTFS_URL}"
  echo_prompt "URL: \c"
  
  prompt_if_interactive
  CHRX_ROOTFS_URL=${PROMPT_RESPONSE:-$CHRX_DEFAULT_ROOTFS_URL}
  
  echo
  echo_info "Download URL: ${CHRX_ROOTFS_URL}"
  echo
  
  echo_prompt "Hostname [default: chrx]: \c"
  prompt_if_interactive
  CHRX_HOSTNAME=${PROMPT_RESPONSE:-chrx}
  
  echo_prompt "Username [default: chrx]: \c"
  prompt_if_interactive
  CHRX_USERNAME=${PROMPT_RESPONSE:-chrx}
  
  echo_prompt "Timezone [default: America/New_York]: \c"
  prompt_if_interactive
  CHRX_TZ=${PROMPT_RESPONSE:-America/New_York}
  
  echo_prompt "Locale [default: en_US.UTF-8]: \c"
  prompt_if_interactive
  CHRX_LOCALE=${PROMPT_RESPONSE:-en_US.UTF-8}
  
  echo
  echo_prompt "Enter root password: "
  read -s CHRX_ROOT_PASSWORD
  echo
  echo_prompt "Confirm root password: "
  read -s CHRX_ROOT_PASSWORD_CONFIRM
  echo
  
  if [ "${CHRX_ROOT_PASSWORD}" != "${CHRX_ROOT_PASSWORD_CONFIRM}" ]; then
    echo_fail "Passwords do not match!"
    exit 1
  fi
  
  if [ -z "${CHRX_ROOT_PASSWORD}" ]; then
    echo_fail "Password cannot be empty!"
    exit 1
  fi
}

validate_url()
{
  echo_info "\nValidating download URL..."
  local response=$(curl -s -I -L -w "%{http_code}" "${CHRX_ROOTFS_URL}" -o /dev/null)
  
  if [ "$response" != "200" ]; then
    echo_fail "Unable to access URL: ${CHRX_ROOTFS_URL}"
    echo_fail "HTTP response code: ${response}"
    exit 1
  fi
  echo_info "URL is accessible."
}

# Replaces all repartitioning logic with the alternate remote setup script
setup_storage()
{
  SETUP_STORAGE_ERROR="failed"

  curl -fsSL -A "${CHRX_UA}" https://raw.githubusercontent.com/trainingdummy/chrx/refs/heads/master/chrx-setup-storage -o /usr/local/bin/chrx-setup-storage
  [ -r /usr/local/bin/chrx-setup-storage ] && . /usr/local/bin/chrx-setup-storage

  if [ "${SETUP_STORAGE_ERROR}" ]; then
    echo_fail "fatal error from chrx-setup-storage. exiting!"
    exit 1
  fi
}

# Everything else below remains the same
do_install()
{
  start_date=$(date)
  start_secs=$(date +%s)

  echo_info "\n${ANSI_GRN}Downloading and extracting rootfs...${ANSI_RST}"
  echo_info "This may take several minutes depending on file size."
  echo

  curl -L ${VERBOSITY_CURL} "${CHRX_ROOTFS_URL}" | tar xzp -C ${CHRX_INSTALL_ROOT}
  
  if [ ${PIPESTATUS[0]} -ne 0 ] || [ ${PIPESTATUS[1]} -ne 0 ]; then
    echo_fail "Fatal: unable to download and extract rootfs archive."
    exit 1
  fi

  echo_info "Rootfs extracted successfully!"
  # [rest of installation process remains unchanged...]
}

# (Remaining functions unchanged: install_grub, show_completion_banner, parse_opts, main)
# ...
